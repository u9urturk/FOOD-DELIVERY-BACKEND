// prisma/schema.prisma
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "darwin-arm64", "darwin"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User & Auth Models

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  name         String?
  surname      String?
  otpSecret    String?
  otpEnabled   Boolean  @default(false)
  recoveryCode String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Profile / Security Extensions
  email                String?   @unique
  passwordHash         String?
  locale               String?   @default("tr-TR")
  timeZone             String?   @default("UTC")
  theme                String?   @default("light")
  density              String?   @default("comfortable")
  notificationEmail    Boolean   @default(true)
  notificationPush     Boolean   @default(true)
  lastLoginAt          DateTime?
  lastPasswordChangeAt DateTime?
  failedMfaAttempts    Int       @default(0)
  mfaLockedUntil       DateTime?
  avatarUrl            String?
  pendingEmail         String?
  pendingEmailToken    String?
  deletedAt            DateTime?

  // Relations (profile related)
  sessions     Session[]
  activityLogs UserActivityLog[]

  // orders             Order[]
  notifications      Notification[]
  userRoles          UserRole[]
  inventoryMovements InventoryMovement[]

  @@map("users")
}

// Session management for refresh tokens / device sessions
model Session {
  id            String         @id @default(cuid())
  userId        String
  user          User           @relation(fields: [userId], references: [id])
  // refreshTokenHash moved to RefreshToken model to support rotation and history
  userAgent     String?
  ip            String?
  createdAt     DateTime       @default(now())
  expiresAt     DateTime
  revokedAt     DateTime?
  revokedReason String?
  // relation to refresh tokens
  refreshTokens RefreshToken[]

  @@index([userId])
  @@map("sessions")
}

// Refresh tokens table - stores token hashes and rotation history
model RefreshToken {
  id            String    @id @default(cuid())
  sessionId     String
  session       Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tokenHash     String
  createdAt     DateTime  @default(now())
  expiresAt     DateTime?
  replacedBy    String? // references RefreshToken.id if needed in app logic
  revokedAt     DateTime?
  revokedReason String?
  ip            String?
  userAgent     String?

  @@index([tokenHash], name: "idx_refresh_token_hash")
  @@map("refresh_tokens")
}

// User activity / audit logging
model UserActivityLog {
  id        String             @id @default(cuid())
  userId    String?
  user      User?              @relation(fields: [userId], references: [id])
  action    UserActivityAction
  context   Json?
  ip        String?
  userAgent String?
  createdAt DateTime           @default(now())

  @@index([userId, createdAt])
  @@map("user_activity_logs")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  rolePermissions RolePermission[]

  @@map("permissions")
}

model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}



model Supplier {
  id                 String          @id @default(uuid())
  name               String
  category           String
  phone              String
  email              String
  rating             Float           @default(0)
  status             SupplierStatus  @default(ACTIVE)
  address            String
  contactPerson      String
  taxNumber          String
  paymentTerms       String
  deliveryTime       Int             @default(0) // gÃ¼n
  minimumOrder       Decimal         @default(0) @db.Decimal(10, 2) // TL
  products           String[]
  contractStartDate  DateTime?
  contractEndDate    DateTime?
  totalOrders        Int             @default(0)
  monthlyDeliveries  Int             @default(0)
  
  // Legacy fields - keep for backward compatibility
  contactInfo        String?
  leadTimeDays       Int?
  isActive           Boolean         @default(true)
  
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  subInventories SubInventory[]

  @@map("suppliers")
}

// Domain models from user's proposal
model BaseUnit {
  id               String   @id @default(uuid())
  name             String   @unique
  desc             String?
  symbol           String?
  shortName        String   @unique
  conversionFactor Float?
  baseUnit         String?
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  products Product[]

  @@map("base_units")
}

model StockType {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  color       String?  @default("from-blue-500 to-blue-600")
  icon        String?  @default("ðŸ“¦")
  examples    String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@map("stock_types")
}

model Category {
  id        String    @id @default(uuid())
  name      String    @unique
  desc      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  products Product[]

  @@map("categories")
}

model Product {
  id            String        @id @default(uuid())
  name          String
  description   String?
  note          String?
  imageUrls     String[]
  status        ProductStatus @default(ACTIVE)

  // Relations
  categoryId  String
  stockTypeId String
  baseUnitId  String

  category  Category  @relation(fields: [categoryId], references: [id])
  stockType StockType @relation(fields: [stockTypeId], references: [id])
  baseUnit  BaseUnit  @relation(fields: [baseUnitId], references: [id])

  inventory          Inventory?
  inventoryMovements InventoryMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("products")
}

model Inventory {
  id          String  @id @default(uuid())
  productId   String  @unique

  currentQuantity Decimal   @db.Decimal(10, 3)
  minStockLevel   Decimal   @db.Decimal(10, 3)
  maxStockLevel   Decimal   @db.Decimal(10, 3)
  lastCountedAt   DateTime?
  expirationDate  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product        Product        @relation(fields: [productId], references: [id])
  subInventories SubInventory[]

  @@map("inventories")
}

model SubInventory {
  id          String  @id @default(uuid())
  inventoryId String
  warehouseId String
  supplierId  String?

  inventory Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  supplier  Supplier? @relation(fields: [supplierId], references: [id])

  unitPrice      Decimal   @db.Decimal(10, 2)
  expirationDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sub_inventories")
}

// Warehouse & Inventory Movement
model Warehouse {
  id                 String              @id @default(uuid())
  name               String
  location           String
  capacity           String
  capacityPercentage Float               @default(0)
  status             WarehouseStatus     @default(ACTIVE)
  manager            String
  staffCount         Int                 @default(0)
  area               Float
  temperature        Float?
  warehouseType      WarehouseType       @default(NORMAL)
  code               String?             @unique
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  // relations: split for clarity because InventoryMovement has two relations to Warehouse
  inventoryFrom InventoryMovement[] @relation("WarehouseFromInventoryMovements")
  inventoryTo   InventoryMovement[] @relation("WarehouseToInventoryMovements")
  subInventories   SubInventory[]

  @@map("warehouses")
}

model MovementType {
  id   String  @id @default(uuid())
  name String  @unique
  desc String?

  inventoryMovements InventoryMovement[]

  @@map("movement_types")
}

model InventoryMovement {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])

  fromWarehouseId String?
  fromWarehouse   Warehouse? @relation("WarehouseFromInventoryMovements", fields: [fromWarehouseId], references: [id])

  toWarehouseId String?
  toWarehouse   Warehouse? @relation("WarehouseToInventoryMovements", fields: [toWarehouseId], references: [id])

  quantity        Decimal          @db.Decimal(10, 3)
  unit            String
  movementTypeId  String
  movementType    MovementType     @relation(fields: [movementTypeId], references: [id])
  sourceEventId   String?
  sourceEventType SourceEventType?
  timestamp       DateTime
  createdAt       DateTime         @default(now())
  userId          String
  user            User             @relation(fields: [userId], references: [id])

  @@map("inventory_movements")
}

// Analytics Models
model RevenueData {
  id            String   @id @default(cuid())
  date          DateTime
  revenue       Decimal  @db.Decimal(10, 2)
  orderCount    Int
  avgOrderValue Decimal  @db.Decimal(10, 2)
  period        Period
  createdAt     DateTime @default(now())

  @@unique([date, period])
  @@map("revenue_data")
}

model TopSellingItem {
  id            String   @id @default(cuid())
  menuItemId    String
  menuItemName  String
  category      String
  totalQuantity Int
  totalRevenue  Decimal  @db.Decimal(10, 2)
  percentage    Decimal  @db.Decimal(5, 2)
  period        DateTime
  createdAt     DateTime @default(now())

  @@map("top_selling_items")
}

model DashboardStats {
  id              String   @id @default(cuid())
  date            DateTime @unique
  totalOrders     Int      @default(0)
  totalRevenue    Decimal  @default(0) @db.Decimal(10, 2)
  totalCustomers  Int      @default(0)
  avgOrderValue   Decimal  @default(0) @db.Decimal(10, 2)
  activeTables    Int      @default(0)
  availableTables Int      @default(0)
  reservedTables  Int      @default(0)
  createdAt       DateTime @default(now())

  @@map("dashboard_stats")
}

// Notification Model
model Notification {
  id        String               @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  isRead    Boolean              @default(false)
  userId    String?
  user      User?                @relation(fields: [userId], references: [id])
  tableId   String?
  orderId   String?
  priority  NotificationPriority @default(MEDIUM)
  createdAt DateTime             @default(now())
  readAt    DateTime?

  @@map("notifications")
}

// Enums

enum MenuStatus {
  ACTIVE
  INACTIVE
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
}

enum TableArea {
  GARDEN
  INDOOR
  TERRACE
}

enum WaiterShift {
  MORNING
  AFTERNOON
  EVENING
  NIGHT
}

enum OrderStatus {
  PENDING
  PREPARING
  READY
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
}

enum StockStatus {
  ACTIVE
  INACTIVE
}

enum StockMovementType {
  IN
  OUT
  ADJUSTMENT
}

enum SourceEventType {
  PURCHASE_ORDER
  SALES_ORDER
  TRANSFER
  ADJUSTMENT
  OTHER
}

enum Period {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum NotificationType {
  ORDER
  PAYMENT
  STOCK
  SYSTEM
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  DRAFT
}

// User activity actions enum for audit logging
enum UserActivityAction {
  PROFILE_UPDATE
  PASSWORD_CHANGE
  MFA_ENABLED
  MFA_DISABLED
  SESSION_REVOKE
  LOGIN_SUCCESS
  LOGIN_FAILURE
  EMAIL_CHANGE_REQUEST
  EMAIL_CHANGE_CONFIRM
}

enum WarehouseStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

enum WarehouseType {
  NORMAL
  COLD
  FROZEN
  DRY
}

enum SupplierStatus {
  ACTIVE
  INACTIVE
  PENDING
}
